<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>çª©å±…æ°£è±¡å°</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black"> 
    <meta name="apple-mobile-web-app-title" content="çª©å±…æ°£è±¡å°">
    <link rel="icon" type="image/png" href="./icon-v2.png">
    <link rel="apple-touch-icon" href="./icon-v2.png">
    <link rel="apple-touch-icon" sizes="180x180" href="./icon-v2.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700;900&display=swap"
        rel="stylesheet">

    <style>
        /* ğŸ¨ å’–å•¡å»³æ¥µç°¡é¢¨æ ¸å¿ƒé…è‰²èˆ‡è®Šæ•¸ */
        :root {
            --cafe-wood-brown: #9E7B5C;      /* æœ¨è³ªæ£•è‰² (æ–‡å­—å’Œå¼·èª¿è‰²) */
            --cafe-cream-bg: #F8F5F1;        /* ç‡•éº¥å¥¶æ²¹ç™½ (å¡ç‰‡èƒŒæ™¯) */
            --cafe-text-dark: #3E3836;       /* æ·±å’–å•¡è‰² (ä¸»è¦æ–‡å­—) */
            --cafe-text-light: #5A534B;      /* æ·ºå’–å•¡è‰² (æ¬¡è¦æ–‡å­—) */
            --cafe-accent-color: #B2A494;    /* æŸ”å’Œä¸­æ€§è‰² (é‚Šæ¡†å’Œè£é£¾) */
            --cafe-shadow-soft: rgba(0, 0, 0, 0.1); /* æŸ”å’Œé™°å½± */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

    body {
        font-family: 'Zen Maru Gothic', 'Noto Sans TC', sans-serif;
        color: var(--cafe-text-dark);
        min-height: 100vh;
        overflow-x: hidden;
        padding-bottom: 20px;
        background-color: #ECECEC;
        
        /* 1. é è¨­è¦å‰‡ (é©ç”¨æ‰€æœ‰è¨­å‚™, é è¨­ç‚ºé›»è…¦/å¹³æ¿æ¨¡å¼) */
        background-image: url('./desktop-background.png'); 
        background-size: cover;
        background-attachment: fixed;
        background-position: center center; /* é›»è…¦å±…ä¸­é¡¯ç¤º */
    }

    /* 2. åª’é«”æŸ¥è©¢ï¼šç•¶è¢å¹•å¯¬åº¦å°æ–¼æˆ–ç­‰æ–¼ 768px æ™‚ (è¦–ç‚ºæ‰‹æ©Ÿ/ç›´ç«‹å¹³æ¿) */
    @media screen and (max-width: 768px) {
        body {
            /* åœ¨æ‰‹æ©Ÿä¸Šï¼Œå°‡åœ–ç‰‡æ›¿æ›ç‚ºç›´ç«‹åœ–ç‰‡ (è‹¥æœ‰) */
            /* ğŸ’¡ é€™è£¡æš«æ™‚ä»ä½¿ç”¨ background.jpgï¼Œä½†å„ªåŒ–ä½ç½® */
            background-image: url('./mobile-background.png'); 
            
            /* å°‡èƒŒæ™¯ä½ç½®è¨­å®šç‚ºå±…ä¸­é ä¸Šï¼Œé¿å…æ‰‹æ©Ÿå…§å®¹å€è¢«åœ–ç‰‡åº•éƒ¨ç´°ç¯€å¹²æ“¾ */
            background-position: center top; 
        }
    }

        /* é ‚éƒ¨ç‹€æ…‹åˆ— (åŠé€æ˜è™•ç†ï¼Œè®“èƒŒæ™¯åœ–é€å‡º) */
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.75); /* è¼•å¾®åŠé€æ˜ */
            backdrop-filter: blur(5px);
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .location-select-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        /* å’–å•¡å»³é¢¨æ ¼ï¼šä¸‹æ‹‰é¸å–® (æº«æš–å¥¶æ²¹è‰²) */
/* å’–å•¡å»³é¢¨æ ¼ï¼šä¸‹æ‹‰é¸å–® (æº«æš–å¥¶æ²¹è‰²) */
        #citySelect {
            background: var(--cafe-cream-bg);
            color: var(--cafe-text-dark);
            padding: 8px 18px;
            border-radius: 8px; /* è¼ƒå°çš„åœ“è§’ */
            font-weight: 700;
            font-size: 1rem;
            transform: none; /* ç§»é™¤æ—‹è½‰ */
            border: 1px solid var(--cafe-accent-color);
            box-shadow: 1px 1px 3px rgba(0, 0, 0, 0.1);
            
            /* æ ¸å¿ƒèª¿æ•´ï¼šç§»é™¤åŸç”Ÿ appearance ä¸¦åŠ å…¥è‡ªè¨‚ç®­é ­ */
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            
            cursor: pointer;
            text-align: center;
            text-align-last: center;

            /* ç®­é ­æ¨£å¼ */
            padding-right: 35px; 
            background-repeat: no-repeat;
            background-position: right 10px center;
            /* é€™è£¡ä½¿ç”¨ Base64 ç·¨ç¢¼çš„ SVGï¼Œé¡è‰²èˆ‡ cafe-wood-brown (#9E7B5C) ä¸€è‡´ */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20'%3E%3Cpath fill='%239E7B5C' d='M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z'/%3E%3C/svg%3E");
            background-size: 14px 14px;
        }
        
        #locateBtn {
            font-size: 1.5rem;
            background: none;
            border: none;
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.2s;
        }
        
        .update-pill {
            font-size: 0.8rem;
            color: var(--cafe-text-light);
            background: var(--cafe-cream-bg);
            padding: 4px 10px;
            border-radius: 8px;
            border: 1px solid var(--cafe-accent-color);
        }

        .container {
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
        }

        /* === æ ¸å¿ƒï¼šä»Šæ—¥ç„¦é»å¡ç‰‡ === */
        .hero-card {
            background: var(--cafe-cream-bg);
            border-radius: 16px; 
            padding: 40px 25px;
            text-align: center;
            box-shadow: 0 8px 15px var(--cafe-shadow-soft);
            border: 1px solid var(--cafe-accent-color);
            margin-bottom: 25px;
            position: relative;
        }

        /* å’–å•¡å»³é¢¨æ ¼ï¼šæ¨™ç±¤ */
        .hero-period {
            position: static; 
            transform: none;
            background: var(--cafe-wood-brown); /* å’–å•¡æ£•æ¨™ç±¤ */
            color: white;
            padding: 5px 15px;
            border-radius: 10px;
            font-weight: bold;
            display: inline-block;
            margin-bottom: 15px;
            box-shadow: none;
            border: none;
        }

        .hero-temp-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin: 15px 0 25px 0;
        }

        .hero-icon {
            font-size: 5rem;
            filter: drop-shadow(0 2px 0 rgba(0, 0, 0, 0.05));
            animation: bounce 3s infinite; /* âœ… ä¿ç•™æ™ƒå‹•æ•ˆæœ */
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .hero-temp {
            font-size: 4.5rem;
            font-weight: 900;
            color: var(--cafe-wood-brown); /* å’–å•¡æ£•æº«åº¦ */
            line-height: 1;
        }

        .hero-desc {
            font-size: 1.2rem;
            color: var(--cafe-text-light);
            margin-bottom: 30px;
            font-weight: normal;
            opacity: 0.9;
        }

        /* === Iäººå»ºè­°å€ (ä¿æŒç¾æœ‰çµæ§‹) === */
        .advice-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--cafe-accent-color);
        }

        .advice-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: rgba(255, 255, 255, 0.9); /* ç•¥å¾®é€æ˜ï¼Œçœ‹åˆ°èƒŒæ™¯åœ– */
            padding: 15px;
            border-radius: 12px;
            min-height: 120px;
            border: 1px solid var(--cafe-accent-color);
        }

        .advice-icon {
            font-size: 2rem;
            margin-bottom: 5px;
        }

        .advice-text {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--cafe-text-dark);
            margin: 5px 0;
            line-height: 1.4;
            text-align: center;
        }

        /* === ç¨å¾Œé å ±ï¼šæ©«å‘æ»‘å‹•å€ === */
        .section-title {
            font-size: 1.2rem;
            color: white; /* è®“æ¨™é¡Œåœ¨æ·±èƒŒæ™¯åœ–ä¸Šä¿æŒå¯è®€æ€§ */
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.7); /* å¢åŠ é™°å½± */
            margin-bottom: 15px;
            margin-left: 10px;
            font-weight: 700;
        }

        .scroll-container {
            display: flex;
            overflow-x: auto;
            gap: 15px;
            padding-bottom: 10px;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .mini-card {
            min-width: 120px; 
            background: var(--cafe-cream-bg);
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            border: 1px solid var(--cafe-accent-color);
            box-shadow: 0 2px 5px var(--cafe-shadow-soft);
            flex-shrink: 0;
        }

        .mini-time {
            min-height: 1.2rem;
            background: var(--cafe-wood-brown);
            color: white;
            padding: 3px 8px;
            border-radius: 8px;
            font-size: 0.75rem;
            display: inline-block;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .mini-icon {
            font-size: 2.2rem;
            margin: 5px 0;
        }

        .mini-temp {
            font-size: 1.1rem;
            font-weight: 800;
            color: var(--cafe-text-dark);
        }

        /* Loading ç•«é¢ */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            /* ä½¿ç”¨èƒŒæ™¯è‰²ï¼Œæˆ–å¯ä»¥ç›´æ¥ä½¿ç”¨åœ–ç‰‡ */
            background-color: var(--cafe-wood-brown); 
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 999;
            color: white;
        }
        
        /* æ²è»¸é¢¨æ ¼å®¢è£½åŒ– (ç¶­æŒä¸Šæ¬¡çš„ä¿®æ”¹ï¼Œä½†é…è‰²æ”¹ç‚ºå’–å•¡é¢¨) */
        #citySelect::-webkit-scrollbar {
            width: 10px; 
        }

        #citySelect::-webkit-scrollbar-track {
            background: var(--cafe-cream-bg); 
            border-radius: 5px;
        }

        #citySelect::-webkit-scrollbar-thumb {
            background-color: var(--cafe-wood-brown); 
            border-radius: 5px;
            border: 2px solid var(--cafe-cream-bg); 
        }

        #citySelect::-webkit-scrollbar-thumb:hover {
            background-color: #7E614A; 
        }
    </style>
</head>

<body>
    <div id="loading" class="loading-screen">
        <div style="font-size: 4rem; animation: bounce 2s infinite;">â˜•</div>
        <p style="color: white; font-weight: bold; margin-top: 20px;">ğŸ§˜ æ­£åœ¨æ€è€ƒï¼Œæœ‰æ²’æœ‰å¿…è¦å‡ºé–€...</p>
    </div>
    
    <div class="status-bar">
        <div class="location-select-container">
            <button id="locateBtn" title="å®šä½ç•¶å‰ä½ç½®">ğŸ“</button>
            <select id="citySelect">
                <option value="loading">è¼‰å…¥åŸå¸‚...</option>
            </select>
        </div>
        <div id="updateTime" class="update-pill">è¼‰å…¥ä¸­...</div>
    </div>

    <div class="container" id="mainContent" style="display: none;">

        <div id="heroCard">
        </div>

        <h3 class="section-title">ç¨å¾Œé å ±</h3>
        <div class="scroll-container" id="futureForecasts">
        </div>

    </div>

    <script>
        const API_BASE_URL = "https://coeai-weather.zeabur.app/api";
        const DEFAULT_CITY = "è‡ºä¸­å¸‚"; 

        const GEO_CITY_MAP = {
            'è‡ºåŒ—å¸‚': [25.0478, 121.5318], 
            'æ–°åŒ—å¸‚': [25.01, 121.46],
            'æ¡ƒåœ’å¸‚': [24.99, 121.31],
            'è‡ºä¸­å¸‚': [24.14, 120.67], 
            'è‡ºå—å¸‚': [22.99, 120.21],
            'é«˜é›„å¸‚': [22.62, 120.31],
            'åŸºéš†å¸‚': [25.13, 121.73],
            'æ–°ç«¹å¸‚': [24.81, 120.97],
            'æ–°ç«¹ç¸£': [24.84, 121.01],
            'è‹—æ —ç¸£': [24.56, 120.82],
            'å½°åŒ–ç¸£': [24.08, 120.54],
            'å—æŠ•ç¸£': [23.97, 120.98],
            'é›²æ—ç¸£': [23.71, 120.43],
            'å˜‰ç¾©å¸‚': [23.47, 120.44],
            'å˜‰ç¾©ç¸£': [23.47, 120.57],
            'å±æ±ç¸£': [22.67, 120.48],
            'å®œè˜­ç¸£': [24.75, 121.75],
            'èŠ±è“®ç¸£': [23.99, 121.60],
            'è‡ºæ±ç¸£': [22.75, 121.15],
            'æ¾æ¹–ç¸£': [23.57, 119.57],
            'é‡‘é–€ç¸£': [24.43, 118.31],
            'é€£æ±Ÿç¸£': [26.15, 119.95],
        };

        // ===============================================
        // Iäººç‰ˆ å¤©æ°£å»ºè­°é‚è¼¯
        // ===============================================
        function getAdvice(rainProb, maxTemp) {
            
            // --- ã€Iäººç‰ˆ å‚˜å…·/å‡ºé–€å»ºè­°ã€‘ ---
            let rainIcon = "ğŸ›‹ï¸"; 
            let rainText = "å¤©æ°£é‚„è¡Œï¼Œä½†åˆ¥å‡ºé–€äº†"; 
            
            // å¦‚æœé™é›¨æ©Ÿç‡é«˜ï¼ˆè¶…é 30%ï¼‰
            if (parseInt(rainProb) > 30) {
                rainIcon = "ğŸš«"; 
                // ä¿®æ­£ï¼šä½¿ç”¨ <strong> æ›¿æ› **
                rainText = "ä¸‹é›¨äº†ï¼é€™æ˜¯å€‹<strong>å®Œç¾</strong>çš„æ‹’çµ•ç†ç”±ï¼"; 
            } else {
                // é™é›¨æ©Ÿç‡ä½
                rainIcon = "ğŸ¤«"; 
                // ä¿®æ­£ï¼šä½¿ç”¨ <strong> æ›¿æ› **
                rainText = "é›–ç„¶æ²’ä¸‹é›¨ï¼Œä½†å¤–é¢äººå¤šï¼Œ<strong>ä¸å¦‚åœ¨å®¶</strong>ã€‚"; 
            }

            // --- ã€Iäººç‰ˆ ç©¿æ­å»ºè­°ã€‘ ---
            let clothIcon = "ğŸ§"; 
            let clothText = "èˆ’é©ç©¿æ­ï¼Œéš¨æ™‚æº–å‚™å›å®¶ã€‚";
            
            // å¦‚æœéå¸¸ç†± (â‰¥ 28Â°C)
            if (parseInt(maxTemp) >= 28) {
                clothIcon = "ğŸ¥µ";
                // ä¿®æ­£ï¼šä½¿ç”¨ <strong> æ›¿æ› **
                clothText = "å¤ªç†±äº†ï¼Œ<strong>ä¸å€¼å¾—å‡ºé–€</strong>ï¼Œå¾…åœ¨å†·æ°£æˆ¿ã€‚"; 
            } 
            // å¦‚æœéå¸¸å†· (â‰¤ 20Â°C)
            else if (parseInt(maxTemp) <= 20) {
                clothIcon = "ğŸ§£";
                // ä¿®æ­£ï¼šä½¿ç”¨ <strong> æ›¿æ› **
                clothText = "æœ‰é»æ¶¼ï¼Œ<strong>å‡ºé–€æ›´å†·</strong>ã€‚è“‹ä¸Šæ¯¯å­å§ã€‚"; 
            } else {
                // æº«åº¦é©ä¸­ (21Â°C ~ 27Â°C)
                clothIcon = "ğŸ’»";
                // ä¿®æ­£ï¼šä½¿ç”¨ <strong> æ›¿æ› **
                clothText = "æº«åº¦å‰›å¥½ï¼Œé©åˆ<strong>å°ˆæ³¨åœ¨é›»è…¦å‰</strong>ã€‚"; 
            }

            return { rainIcon, rainText, clothIcon, clothText };
        }
        // ===============================================
        // å…¶ä»–å·¥å…·å‡½æ•¸ (ä¿æŒä¸è®Š)
        // ===============================================

        function getWeatherIcon(weather) {
            if (!weather) return "ğŸŒ¤ï¸";
            if (weather.includes("æ™´")) return "â˜€ï¸";
            if (weather.includes("å¤šé›²")) return "â›…";
            if (weather.includes("é™°")) return "â˜ï¸";
            if (weather.includes("é›¨")) return "ğŸŒ§ï¸";
            if (weather.includes("é›·")) return "â›ˆï¸";
            return "ğŸŒ¤ï¸";
        }

        function getTimePeriod(startTime) {
            const hour = new Date(startTime).getHours();
            if (hour >= 5 && hour < 11) return "æ—©æ™¨";
            if (hour >= 11 && hour < 14) return "ä¸­åˆ";
            if (hour >= 14 && hour < 18) return "ä¸‹åˆ";
            if (hour >= 18 && hour < 23) return "æ™šä¸Š";
            return "æ·±å¤œ";
        }

        function findNearestCity(lat, lon) {
            let nearestCity = DEFAULT_CITY;
            let minDistanceSq = Infinity;

            for (const city in GEO_CITY_MAP) {
                const [cityLat, cityLon] = GEO_CITY_MAP[city];
                const distanceSq = Math.pow(lat - cityLat, 2) + Math.pow(lon - cityLon, 2); 

                if (distanceSq < minDistanceSq) {
                    minDistanceSq = distanceSq;
                    nearestCity = city;
                }
            }
            return nearestCity;
        }
        
        // ===============================================
        // æ ¸å¿ƒè³‡æ–™æµç¨‹å‡½æ•¸
        // ===============================================

        function renderWeather(data) {
            const citySelect = document.getElementById('citySelect');
            if (citySelect.value !== data.city) {
                citySelect.value = data.city;
            }

            const forecasts = data.forecasts;
            const current = forecasts[0];
            const others = forecasts.slice(1);

            // 1. æ¸²æŸ“ Hero Card (ä¸»ç•«é¢)
            const advice = getAdvice(current.rain, current.maxTemp);
            const period = getTimePeriod(current.startTime);
            const avgTemp = Math.round((parseInt(current.maxTemp) + parseInt(current.minTemp)) / 2);

            document.getElementById('heroCard').innerHTML = `
                        <div class="hero-card">
                            <div class="hero-period">${period}</div>
                            <div class="hero-temp-container">
                                <div class="hero-icon">${getWeatherIcon(current.weather)}</div>
                                <div class="hero-temp">${avgTemp}Â°</div>
                            </div>
                            <div class="hero-desc">${current.weather}</div>
                            
                            <div class="advice-grid">
                                <div class="advice-item">
                                    <div class="advice-icon">${advice.rainIcon}</div>
                                    <div class="advice-text">${advice.rainText}</div>
                                    <div style="font-size:0.7rem; color:#999">é™é›¨ç‡ ${current.rain}</div>
                                </div>
                                <div class="advice-item">
                                    <div class="advice-icon">${advice.clothIcon}</div>
                                    <div class="advice-text">${advice.clothText}</div>
                                    <div style="font-size:0.7rem; color:#999">æœ€é«˜æº« ${current.maxTemp}Â°</div>
                                </div>
                            </div>
                        </div>
                    `;

            // 2. æ¸²æŸ“ç¨å¾Œé å ± (æ©«å‘æ»‘å‹•å€)
            const scrollContainer = document.getElementById('futureForecasts');
            scrollContainer.innerHTML = '';
            const todayDate = new Date().getDate();

            others.forEach(f => {
                let p = getTimePeriod(f.startTime);
                const fDate = new Date(f.startTime);
                if (fDate.getDate() !== todayDate) {
                    p = "æ˜å¤©" + p;
                }

                scrollContainer.innerHTML += `
                                <div class="mini-card">
                                    <div class="mini-time">${p}</div>
                                    <div class="mini-icon">${getWeatherIcon(f.weather)}</div>
                                    <div class="mini-temp">${f.minTemp} - ${f.maxTemp}</div>
                                    <div style="font-size:0.8rem; color:#888; margin-top:5px;">ğŸ’§${f.rain}</div>
                                </div>
                            `;
            });

            // 3. å³ä¸Šè§’é¡¯ç¤ºæ—¥æœŸ
            const now = new Date();
            const month = now.getMonth() + 1;
            const date = now.getDate();
            const dayIndex = now.getDay();
            const days = ["é€±æ—¥", "é€±ä¸€", "é€±äºŒ", "é€±ä¸‰", "é€±å››", "é€±äº”", "é€±å…­"];
            document.getElementById('updateTime').textContent = `${month}æœˆ${date}æ—¥ ${days[dayIndex]}`;

            document.getElementById('loading').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
        }

        async function fetchWeather(city) {
            document.getElementById('loading').style.display = 'flex';
            document.getElementById('mainContent').style.display = 'none';
            document.getElementById('updateTime').textContent = 'æ›´æ–°ä¸­...';

            try {
                const fetchUrl = `${API_BASE_URL}/weather/${city}`;
                
                // ç‚ºäº†è®“ loading ç•«é¢è‡³å°‘é¡¯ç¤º 1.5 ç§’
                const delayPromise = new Promise(resolve => setTimeout(resolve, 1500));
                const fetchPromise = fetch(fetchUrl).then(res => res.json());

                const [_, json] = await Promise.all([delayPromise, fetchPromise]);

                if (json.success) {
                    renderWeather(json.data);
                } else {
                    throw new Error(json.message || "API Error");
                }
            } catch (e) {
                console.error(e);
                alert(`æŸ¥è©¢ ${city} å¤©æ°£è³‡æ–™å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚`);
                document.getElementById('loading').style.display = 'none';
            }
        }

        async function populateCitySelect(initialCity) {
            const selectElement = document.getElementById('citySelect');
            selectElement.innerHTML = '<option value="loading" disabled>è¼‰å…¥åŸå¸‚...</option>';

            try {
                const response = await fetch(`${API_BASE_URL}/cities`);
                const json = await response.json();

                if (json.success && Array.isArray(json.data)) {
                    selectElement.innerHTML = ''; 
                    
                    json.data.forEach(city => {
                        const option = document.createElement('option');
                        option.value = city;
                        option.textContent = city;
                        selectElement.appendChild(option);
                    });

                    selectElement.value = initialCity || DEFAULT_CITY;

                    selectElement.addEventListener('change', (e) => {
                        fetchWeather(e.target.value);
                    });
                } else {
                    throw new Error("ç„¡æ³•å–å¾—åŸå¸‚åˆ—è¡¨");
                }
            } catch(e) {
                console.error("è¼‰å…¥åŸå¸‚åˆ—è¡¨å¤±æ•—:", e);
                selectElement.innerHTML = `<option value="${DEFAULT_CITY}">${DEFAULT_CITY} (è¼‰å…¥å¤±æ•—)</option>`;
                selectElement.value = DEFAULT_CITY;
                selectElement.disabled = true;
            }
        }

        function attemptGeolocation() {
            return new Promise((resolve) => {
                if (!navigator.geolocation) {
                    console.warn("ç€è¦½å™¨ä¸æ”¯æ´åœ°ç†å®šä½ã€‚");
                    resolve(DEFAULT_CITY); 
                    return;
                }

                const locateBtn = document.getElementById('locateBtn');
                locateBtn.textContent = 'ğŸ“¡'; 
                locateBtn.disabled = true;

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        const detectedCity = findNearestCity(lat, lon);
                        console.log(`å®šä½æˆåŠŸï¼Œç•¶å‰ä½ç½®ï¼š${detectedCity}`);
                        locateBtn.textContent = 'ğŸ“';
                        locateBtn.disabled = false;
                        resolve(detectedCity);
                    },
                    (error) => {
                        let message = "å®šä½å¤±æ•—ï¼Œå°‡é¡¯ç¤ºé è¨­åŸå¸‚å¤©æ°£ã€‚";
                        if (error.code === error.PERMISSION_DENIED) {
                            message = "ğŸ“ æ‚¨å·²æ‹’çµ•å­˜å–ä½ç½®ã€‚å°‡é¡¯ç¤ºé è¨­åŸå¸‚å¤©æ°£ã€‚";
                        } else if (error.code === error.TIMEOUT) {
                            message = "å®šä½è¶…æ™‚ï¼Œå°‡é¡¯ç¤ºé è¨­åŸå¸‚å¤©æ°£ã€‚";
                        }
                        console.error("Geolocation éŒ¯èª¤:", error.message);
                        alert(message);
                        
                        locateBtn.textContent = 'ğŸ“';
                        locateBtn.disabled = false;
                        resolve(DEFAULT_CITY); 
                    },
                    { enableHighAccuracy: false, timeout: 5000, maximumAge: 0 }
                );
            });
        }

        // ===================================
        // æ‡‰ç”¨ç¨‹å¼å•Ÿå‹•ä¸»å‡½æ•¸
        // ===================================
        async function initializeApp() {
            // 1. ç¶²é è¼‰å…¥æ™‚ï¼Œå…ˆå˜—è©¦å®šä½
            const initialCity = await attemptGeolocation();
            
            // 2. è¼‰å…¥ä¸‹æ‹‰é¸å–® (ä½¿ç”¨å®šä½çµæœä½œç‚ºåˆå§‹åŸå¸‚)
            await populateCitySelect(initialCity);
            
            // 3. æ ¹æ“šæœ€çµ‚æ±ºå®šçš„åŸå¸‚å‘¼å«å¤©æ°£ API
            const finalCity = document.getElementById('citySelect').value;
            fetchWeather(finalCity);
            
            // 4. ç¶å®šã€Œæˆ‘çš„ä½ç½®ã€æŒ‰éˆ•äº‹ä»¶ (æ‰‹å‹•é‡è©¦)
            document.getElementById('locateBtn').addEventListener('click', () => {
                 attemptGeolocation().then(city => fetchWeather(city));
            });
        }

        document.addEventListener("DOMContentLoaded", initializeApp);
    </script>
</body>

</html>